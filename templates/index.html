<!DOCTYPE html>
<html>
<head>
    <title>Multiverso</title>
    <script src="https://d3js.org/d3.v5.min.js"></script>
    <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='styles.css') }}">
</head>
<body>
   
    <div class="banner">
        <h1 class="page-title">Multiverso De las tierras </h1>
    </div> 

    <div class="buttons-container">
        <button id="add-node-button">Agregar Planeta Tierra</button>
        <button id="remove-node-button">Eliminar Planeta Tierra</button>
    </div>
    
    <div class="buttons-container">
        <div id="normal-travel-container">
            <select id="adjacent-nodes-dropdown">
                <option value="">Selecciona un Planeta Tierra</option>
            </select>
            <button id="travel-button">Viajar</button>
        </div>
    </div>
    
    <div class="buttons-container">
        <div>
            <select id="all-nodes-dropdown">
                <option value="">Selecciona un Planeta Tierra</option>
            </select>
            <button onclick="startFastJourney()">Iniciar viaje rápido</button>
        </div>
    </div>

    <div class="nodes-text-container">
        <p id="selected-node" class="info-text">Planeta tierra seleccionada: 0</p>
        <p id="node-counter" class="info-text">Planetas tierras en el multiverso: 0</p>
    </div>

    <div id="graph"></div>

    </div>
    
    <script src="main.js"></script>
<div class="transparent-container">
    <script>
        let previousNode;
        let currentNode;
        let messengerNode = 0;
        let travelPath = [];
        let isFirstLoad = true;

        var svg = d3.select("#graph").append("svg")
            .attr("width", "100%")
            .attr("height", "100%")
            .attr("viewBox", "0 0 1920 1920")
            .style("display", "block")
            .style("margin", "auto");

            
    window.onscroll = function() {
        var title = document.querySelector('.page-title');
        if (window.pageYOffset > 50) {
            title.classList.add('scroll-down');
        } else {
            title.classList.remove('scroll-down');
        }
    };

    function getRandomColor() {
        var r = Math.floor(Math.random() * 256);
        var g = Math.floor(Math.random() * 256);
        var b = Math.floor(Math.random() * 256);
        return "rgb(" + r + "," + g + "," + b + ")";
    }

    function selectFirstAvailableNode(start, end) {
        for (let i = start; i <= end; i++) {
            fetch('/select_node/' + i)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('No se pudo seleccionar el nodo ' + i);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data) {
                        document.getElementById('selected-node').textContent = 'Nodo seleccionado: ' + i;
                        var dropdown = document.getElementById('adjacent-nodes-dropdown');
                        dropdown.innerHTML = '<option value="">Selecciona una tierra</option>';

                        // Filtramos el nodo mensajero de la lista de nodos adyacentes
                        var adjacentNodes = data.adjacent_nodes.filter(node => node !== messengerNode);

                        for (var j = 0; j < adjacentNodes.length; j++) {
                            var option = document.createElement('option');
                            option.value = adjacentNodes[j];
                            option.text = 'Nodo ' + adjacentNodes[j];
                            dropdown.appendChild(option);
                        }

                        drawGraph(data);
                        throw new Error('Nodo seleccionado: ' + i);
                    }
                })
                .catch(error => {
                    if (i === end) {
                        console.error('No se pudo seleccionar ningún nodo en el rango de ' + start + ' a ' + end);
                    }
                });
        }
    }

    function addNode() {
        fetch('/add_node')
            .then(response => response.json())
            .then(data => {
                drawGraph(data);
                fillAllNodesDropdown(data.nodes); // Actualiza la lista de nodos disponibles
                document.getElementById('node-counter').textContent = 'Planetas tierras : ' + data.nodes.length;

            });
    }
    function selectNode(nodeId) {
        fetch('/select_node/' + nodeId)
            .then(response => {
                if (!response.ok) {
                    throw new Error('No se pudo seleccionar el nodo ' + nodeId);
                }
                return response.json();
            })
            .then(data => {
                if (data) {
                    document.getElementById('selected-node').textContent = 'Planeta tierra seleccionada: ' + nodeId;
                    var dropdown = document.getElementById('adjacent-nodes-dropdown');
                    dropdown.innerHTML = '<option value="">Selecciona una tierra</option>';

                    // Obtiene el nodo anterior
                    var previousNode = travelPath[travelPath.length - 2]; // Obtiene el penúltimo nodo visitado

                    // Filtra el nodo anterior de la lista de nodos adyacentes
                    var adjacentNodes = data.adjacent_nodes.filter(node => node !== previousNode);

                    for (var j = 0; j < adjacentNodes.length; j++) {
                        var option = document.createElement('option');
                        option.value = adjacentNodes[j];
                        option.text = 'Planeta Tierra ' + adjacentNodes[j];
                        dropdown.appendChild(option);
                    }


                    // Añade el nodo actual al final de la ruta de viaje
                    travelPath.push(nodeId);
                    console.log(travelPath); // Imprime el array travelPath en la consola

                    drawGraph(data);

                    // Almacena el nodo seleccionado en el almacenamiento local
                    localStorage.setItem('selectedNode', nodeId)
                    if (data.description) {
                        document.getElementById('node-description').textContent = data.description;
                    } else {
                        console.error('La descripción del nodo no está disponible');
                    }
                }  
            });
        }
    function fillAllNodesDropdown(nodes) {
        var dropdown = document.getElementById('all-nodes-dropdown');
        dropdown.innerHTML = '<option value="">Selecciona una tierra</option>';

        for (var i = 0; i < nodes.length; i++) {
            var option = document.createElement('option');
            option.value = nodes[i].id;
            option.text = 'Planeta Tierra ' + nodes[i].id;
            dropdown.appendChild(option);
        }
    }

    function startFastJourney() {
        var dropdown = document.getElementById('all-nodes-dropdown');
        var selectedNode = dropdown.value;

        if (selectedNode) {
            selectNode(selectedNode);
        } else {
            alert('Por favor, selecciona un nodo para iniciar el viaje rápido');
        }
    }


    // Función para eliminar un nodo
    function removeNode() {
        fetch('/remove_node')
            .then(response => response.json())
            .then(data => {
                drawGraph(data);
                fillAllNodesDropdown(data.nodes); // Actualiza la lista de nodos disponibles
                document.getElementById('node-counter').textContent = 'Planetas tierras en el multiverso: ' + data.nodes.length;

            });
    }

    // Elimina cualquier gráfico existente
    function drawGraph(data) {
        // Elimina cualquier gráfico existente
        svg.selectAll("*").remove();

        fillAllNodesDropdown(data.nodes);
        var nodes = data.nodes;
        var links = data.links;

        // Crea una lista de enlaces en la ruta de viaje
        var travelLinks = [];
        for (var i = 0; i < travelPath.length - 1; i++) {
            var sourceNode = nodes.find(node => node.id === travelPath[i]);
            var targetNode = nodes.find(node => node.id === travelPath[i + 1]);
            travelLinks.push({source: sourceNode, target: targetNode});
        }

        var simulation = d3.forceSimulation(nodes)
            .force("link", d3.forceLink(links).id(d => d.id).distance(1000))
            .force("charge", d3.forceManyBody().strength(-500))
            .force("center", d3.forceCenter(1920 / 2, 1920 / 2));

        var link = svg.append("g")
            .attr("stroke", "#ffffff")
            .attr("stroke-opacity", 0.6)
            .selectAll("line")
            .data(links)
            .join("line")
            .attr("stroke-width", 2)
            .attr("stroke", function(d) {
                // Si el enlace está en la ruta de viaje, cambia su color a verde
                for (var i = 0; i < travelLinks.length; i++) {
                    if ((d.source === travelLinks[i].source && d.target === travelLinks[i].target) ||
                        (d.source === travelLinks[i].target && d.target === travelLinks[i].source)) {
                        return "green";
                    }
                }
                return "#ffffff";
            });

        var node = svg.append("g")
            .attr("stroke", "#fff")
            .attr("stroke-width", 1.5)
            .selectAll("circle")
            .data(nodes)
            .join("circle")
                .attr("r", 20)
                .attr("fill", getRandomColor);

        var labels = svg.append("g")
            .selectAll("text")
            .data(nodes)
            .join("text")
            .text(d => d.id)
            .attr("x", d => d.x + 10)
            .attr("y", d => d.y + 4)
            .style("font-size", "35px")
            .style("font-weight", "bold");

        simulation.on("tick", () => {
            link
                .attr("x1", d => d.source.x)
                .attr("y1", d => d.source.y)
                .attr("x2", d => d.target.x)
                .attr("y2", d => d.target.y);

            node
                .attr("cx", d => d.x)
                .attr("cy", d => d.y);

            labels
                .attr("x", d => d.x + 10)
                .attr("y", d => d.y + 4);
        });

    }

    // Obtén los datos del grafo cuando la página se carga por primera vez
            // Cuando se carga la página, obtén los datos del grafo y actualiza el contador de nodos
    fetch('/graph_data')
        .then(response => response.json())
        .then(data => {
            drawGraph(data);
            document.getElementById('node-counter').textContent = 'Planetas tierras en el multiverso: ' + data.nodes.length;
        });
    
    // Cuando se hace clic en el botón "Agregar nodo", agrega un nuevo nodo al grafo
    document.getElementById('add-node-button').addEventListener('click', function() {
        addNode();
    });

    document.getElementById('remove-node-button').addEventListener('click', function() {
        removeNode();
    });

    document.getElementById('travel-button').addEventListener('click', function() {
        var dropdown = document.getElementById('adjacent-nodes-dropdown');
        var selectedNodeId = dropdown.options[dropdown.selectedIndex].value;
        if (selectedNodeId) {
            selectNode(selectedNodeId);
            console.log(travelPath); // Imprime el array travelPath en la consola
            // Actualiza el nodo seleccionado después de viajar
            document.getElementById('selected-node').textContent = 'Planeta tierra seleccionada: ' + selectedNodeId;
        }
    });

    window.onload = function() {
        var isFirstLoad = localStorage.getItem('isFirstLoad');
        if (!isFirstLoad) {
            selectNode(0);
            localStorage.setItem('isFirstLoad', 'false');
        } else {
            var selectedNode = localStorage.getItem('selectedNode');
            if (selectedNode) {
                selectNode(selectedNode);
            } else {
                selectNode(0);
            }
        }
    };

        
    </script>
    
</div>
<div id="node-description-container" class="description-container">
    <p id="node-description"></p>
</div>
<footer class="page-footer">
    <p>&copy; Cristian Moreno , Cesar Epia , Sebatián Olarte </p>
    <p>&copy; 2023 Universidad Nacional de Colombia</p>
</footer>
</body>
</html>